box: wercker/nodejs
build:
  steps:
    - npm-install
    - script:
        name: wintersmith build
        code: ./node_modules/.bin/wintersmith --config=./config_production.json build -o ./build
    - script:
        name: CSS compression
        code: |-
          sudo npm install clean-css -g
          sudo npm install uglify-js -g
          cd ${WERCKER_ROOT}/build/css/
          cat bootstrap.css style.css posts.css | cleancss --s0 -o bundle-default.css
          cat bootstrap.css style.css posts.css photos.css | cleancss --s0 -o bundle-photos.css
          cd ${WERCKER_ROOT}/build/js/
          uglifyjs jquery.ga.js jquery.lazyload.min.js slowtheory.js -c -o bundle-default.js
          uglifyjs jquery.ga.js jquery.lazyload.min.js slowtheory.js search.js -c -o bundle-search.js
          uglifyjs jquery.ga.js bootstrap.js photos.js -c -o bundle-photos.js
deploy:
  steps:
    - s3sync:
         key_id: $KEY
         key_secret: $SECRET
         bucket_url: $URL
         source_dir: build/
    # - script:
    #     name: Cloudfiles deployment
    #     code: |
    #       sudo pip install turbolift
    #       turbolift -a ${CLOUD_FILES_APIKEY} -u ${CLOUD_FILES_USERNAME} --os-rax-auth ord upload --sync -s ${WERCKER_ROOT}/build/ -c www.slowtheory.com
